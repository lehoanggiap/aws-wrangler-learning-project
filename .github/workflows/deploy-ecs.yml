name: Deploy FastAPI to ECS

on:
  workflow_dispatch: # Allow manual triggering

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  # Image tagging variables
  IMAGE_TAG: ${{ github.sha }}
  BUILD_DATE: ${{ github.event.head_commit.timestamp }}

jobs:
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper git describe

      - name: Set up build variables
        id: build-vars
        run: |
          # Generate build variables for image tagging
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "VCS_REF=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "VERSION=$(git describe --tags --always --dirty)" >> $GITHUB_ENV
          echo "IMAGE_TAG=${GITHUB_SHA:0:8}" >> $GITHUB_ENV
          
          # Output for debugging
          echo "ğŸ·ï¸  Build Variables:"
          echo "BUILD_DATE: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "VCS_REF: $(git rev-parse --short HEAD)"
          echo "VERSION: $(git describe --tags --always --dirty)"
          echo "IMAGE_TAG: ${GITHUB_SHA:0:8}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS credentials
        run: |
          aws sts get-caller-identity
          echo "âœ… AWS credentials configured successfully"

      - name: Set up Node.js for CDK
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up Python for CDK
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK CLI
        run: |
          npm install -g aws-cdk@latest
          cdk --version

      - name: Install CDK dependencies
        working-directory: infrastructure
        run: |
          # Install Python dependencies for CDK
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: CDK Bootstrap (if needed)
        working-directory: infrastructure
        run: |
          echo "ğŸ” Checking if CDK bootstrap is needed..."
          # Check if bootstrap stack exists
          if ! aws cloudformation describe-stacks --stack-name CDKToolkit --region ${{ secrets.AWS_REGION }} > /dev/null 2>&1; then
            echo "ğŸš€ Running CDK bootstrap..."
            cdk bootstrap aws://$(aws sts get-caller-identity --query Account --output text)/${{ secrets.AWS_REGION }}
          else
            echo "âœ… CDK bootstrap already exists"
          fi

      - name: CDK Synth
        working-directory: infrastructure
        env:
          # Pass build variables to CDK
          CDK_BUILD_DATE: ${{ env.BUILD_DATE }}
          CDK_VCS_REF: ${{ env.VCS_REF }}
          CDK_VERSION: ${{ env.VERSION }}
        run: |
          echo "ğŸ”„ Synthesizing CDK stack with build metadata..."
          echo "Using BUILD_DATE: $CDK_BUILD_DATE"
          echo "Using VCS_REF: $CDK_VCS_REF"
          echo "Using VERSION: $CDK_VERSION"
          cdk synth

      - name: CDK Diff
        working-directory: infrastructure
        run: |
          echo "ğŸ“‹ Showing deployment diff..."
          cdk diff || true # Don't fail if there are differences

      - name: CDK Deploy
        working-directory: infrastructure
        env:
          # Pass build variables to CDK
          CDK_BUILD_DATE: ${{ env.BUILD_DATE }}
          CDK_VCS_REF: ${{ env.VCS_REF }}
          CDK_VERSION: ${{ env.VERSION }}
        run: |
          echo "ğŸš€ Deploying to ECS with image tag: ${{ env.IMAGE_TAG }}..."
          echo "Build metadata:"
          echo "  Date: $CDK_BUILD_DATE"
          echo "  Commit: $CDK_VCS_REF"
          echo "  Version: $CDK_VERSION"
          cdk deploy --require-approval never --verbose
          echo "âœ… Deployment completed successfully!"

      - name: Get deployment outputs
        working-directory: infrastructure
        run: |
          echo "ğŸ“¤ Getting deployment outputs..."
          aws cloudformation describe-stacks \
            --stack-name InfrastructureStack \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Stacks[0].Outputs[*].{Key:OutputKey,Value:OutputValue,Description:Description}' \
            --output table

      - name: Health check
        run: |
          echo "ğŸ¥ Performing health check..."
          # Get the load balancer URL from stack outputs
          LB_URL=$(aws cloudformation describe-stacks \
            --stack-name InfrastructureStack \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerURL`].OutputValue' \
            --output text)
          
          if [ ! -z "$LB_URL" ]; then
            echo "ğŸ”— Load Balancer URL: $LB_URL"
            
            # Wait a bit for the service to be ready
            echo "â³ Waiting 60 seconds for service to be ready..."
            sleep 60
            
            # Try health check (with retries)
            for i in {1..5}; do
              echo "ğŸ” Health check attempt $i/5..."
              if curl -f -s "$LB_URL/health" > /dev/null; then
                echo "âœ… Health check passed!"
                break
              else
                echo "âš ï¸  Health check failed, retrying in 30 seconds..."
                sleep 30
              fi
              
              if [ $i -eq 5 ]; then
                echo "âŒ Health check failed after 5 attempts"
                echo "ğŸ” Check ECS service status and logs in AWS Console"
              fi
            done
          else
            echo "âš ï¸  Could not retrieve Load Balancer URL"
          fi

      - name: Get ECR image information
        run: |
          echo "ğŸ³ ECR Image Information:"
          # Get the ECR repository URI from the bootstrap stack
          ECR_REPO=$(aws cloudformation describe-stacks \
            --stack-name CDKToolkit \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ContainerAssetsRepositoryName`].OutputValue' \
            --output text 2>/dev/null || echo "cdk-assets")
          
          if [ ! -z "$ECR_REPO" ]; then
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            ECR_URI="$ACCOUNT_ID.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/$ECR_REPO"
            echo "ğŸ“¦ ECR Repository: $ECR_URI"
            
            # List recent images
            echo "ğŸ·ï¸  Recent images:"
            aws ecr describe-images \
              --repository-name $ECR_REPO \
              --region ${{ secrets.AWS_REGION }} \
              --max-items 5 \
              --query 'imageDetails[*].{Pushed:imagePushedAt,Tags:imageTags,Digest:imageDigest}' \
              --output table 2>/dev/null || echo "Could not retrieve image list"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "===================="
          echo "ğŸŒ Region: ${{ secrets.AWS_REGION }}"
          echo "ğŸ—ï¸  Stack: InfrastructureStack"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ”— GitHub SHA: ${{ github.sha }}"
          echo "ğŸ·ï¸  Image Tag: ${{ env.IMAGE_TAG }}"
          echo "ğŸ“ Version: ${{ env.VERSION }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          
          # Show ECS service status
          echo ""
          echo "ğŸ³ ECS Service Status:"
          aws ecs describe-services \
            --cluster yaki-fastapi-cluster \
            --services YakiFargateService \
            --region ${{ secrets.AWS_REGION }} \
            --query 'services[0].{Status:status,RunningCount:runningCount,DesiredCount:desiredCount,TaskDefinition:taskDefinition}' \
            --output table || echo "Could not retrieve ECS service status" 